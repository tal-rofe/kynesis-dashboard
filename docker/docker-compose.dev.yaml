version: '3.8'

services:
    mongo_launcher:
        container_name: mongo_launcher
        image: mongo:7.0.4
        restart: on-failure
        networks:
            - dashboard_network
        volumes:
            - ./scripts/mongo-setup.sh:/scripts/mongo-setup.sh
        entrypoint: ['sh', '/scripts/mongo-setup.sh']
    mongo_replica_1:
        container_name: mongo_replica_1
        image: mongo:7.0.4
        ports:
            - 27017:27017
        restart: always
        entrypoint: ['/usr/bin/mongod', '--bind_ip_all', '--replSet', 'dbrs', '--dbpath', '/data/db', '--port', '27017']
        volumes:
            - ./.volumes/mongo/replica1:/data/db
            - ./.volumes/mongo/replica1/configdb:/data/configdb
        networks:
            - dashboard_network
    mongo_replica_2:
        container_name: mongo_replica_2
        image: mongo:7.0.4
        ports:
            - 27018:27018
        restart: always
        entrypoint: ['/usr/bin/mongod', '--bind_ip_all', '--replSet', 'dbrs', '--dbpath', '/data/db', '--port', '27018']
        volumes:
            - ./.volumes/mongo/replica2:/data/db
            - ./.volumes/mongo/replica2/configdb:/data/configdb
        networks:
            - dashboard_network
    mongo_replica_3:
        container_name: mongo_replica_3
        image: mongo:7.0.4
        ports:
            - 27019:27019
        restart: always
        entrypoint: ['/usr/bin/mongod', '--bind_ip_all', '--replSet', 'dbrs', '--dbpath', '/data/db', '--port', '27019']
        volumes:
            - ./.volumes/mongo/replica3:/data/db
            - ./.volumes/mongo/replica3/configdb:/data/configdb
        networks:
            - dashboard_network

    localstack:
        container_name: '${LOCALSTACK_DOCKER_NAME:-localstack-main}'
        image: localstack/localstack
        ports:
            - '127.0.0.1:4566:4566'
            - '127.0.0.1:4510-4559:4510-4559'
        environment:
            - DEBUG=${DEBUG:-0}
            - PERSISTENCE=${PERSISTENCE:-0}
        volumes:
            - '${LOCALSTACK_VOLUME_DIR:-./volume}:/var/lib/localstack'
            - '/var/run/docker.sock:/var/run/docker.sock'

    frontend-dashboard:
        container_name: frontend-dashboard
        build:
            context: ..
            dockerfile: ./docker/Dockerfile.frontend-dashboard-dev
        environment:
            - NODE_ENV=test
        env_file:
            - ../apps/frontend-dashboard/envs/.env.development
        ports:
            - 8080:8080
        restart: always
        networks:
            - dashboard_network
        volumes:
            - type: bind
              source: ../apps/frontend-dashboard/src
              target: /dashboard/apps/frontend-dashboard/src
            - /dashboard/apps/frontend-dashboard/node_modules

networks:
    dashboard_network:
        driver: bridge
